{% extends 'base.html' %}

{% block title %}Inventario - Mundo Cartas{% endblock %}

{% block page_header %}Gesti√≥n de Inventario{% endblock %}

{% block content %}
<!-- Main Layout -->
<div class="main-layout">
    <!-- Left Panel - Form -->
    <div class="form-panel">
        <div class="section-title" id="form-title">
            {% if user.perfilusuario.rol.nombre == 'Administrador' %}
                REGISTRO DE PRODUCTO NUEVO
            {% else %}
                REGISTRO DE PRODUCTO NUEVO (Solo lectura para edici√≥n)
            {% endif %}
        </div>
        
        <form method="POST" id="producto-form" action="{% url 'inventario:crear_producto' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="producto_id" id="producto_id">
            
            <div class="form-group">
                <label class="form-label required">Nombre del Producto:</label>
                <input type="text" name="nombre" id="nombre" class="form-input" 
                       placeholder="Ej: Starter Deck Digimon TCG Double Typhoon" required>
            </div>
            
            <div class="form-group">
                <label class="form-label required">Categor√≠a:</label>
                <select name="categoria" id="categoria" class="form-select" required>
                    <option value="">Seleccionar categor√≠a...</option>
                    {% for categoria in categorias %}
                    <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Subcategor√≠a (Franquicia):</label>
                <select name="subcategoria" id="subcategoria" class="form-select">
                    <option value="">Seleccionar subcategor√≠a...</option>
                    {% for subcategoria in subcategorias %}
                    <option value="{{ subcategoria.id }}">{{ subcategoria.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Campo de imagen -->
            <div class="form-group">
                <label class="form-label">Imagen del Producto:</label>
                <div style="margin-bottom: 10px;">
                    <img id="imagen-preview" src="/static/images/no-image.png" 
                         style="width: 150px; height: 150px; object-fit: cover; border: 2px solid #d0d0d0; border-radius: 8px; display: block; margin-bottom: 10px;">
                </div>
                <input type="file" name="imagen" id="imagen" class="form-input" 
                       accept="image/jpeg,image/png,image/jpg,image/webp"
                       onchange="previewImagen(this)">
                <small style="font-size: 11px; color: #666; display: block; margin-top: 5px;">
                    Formatos: JPG, PNG, WEBP (m√°x. 5MB)
                </small>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label required">Precio:</label>
                    <input type="number" name="precio" id="precio" class="form-input" 
                           placeholder="$0" min="1" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Stock Inicial:</label>
                    <input type="number" name="stock" id="stock" class="form-input" 
                           placeholder="0" min="0" required>
                </div>
            </div>

            <div class="info-box">
                <strong>üìä Configuraci√≥n de Alertas de Stock:</strong><br>
                Define cu√°ndo este producto debe mostrar alertas de stock bajo o cr√≠tico.
            </div>
            
            <div class="form-row-3">
                <div class="form-group">
                    <label class="form-label">Stock M√≠nimo:</label>
                    <input type="number" name="stock_minimo" id="stock_minimo" class="form-input" 
                           placeholder="5" min="0" value="5">
                    <small style="font-size: 10px; color: #666;">Alerta amarilla</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stock Cr√≠tico:</label>
                    <input type="number" name="stock_critico" id="stock_critico" class="form-input" 
                           placeholder="2" min="0" value="2">
                    <small style="font-size: 10px; color: #666;">Alerta roja</small>
                </div>

                <div class="form-group">
                    <label class="form-label">&nbsp;</label>
                    <div style="font-size: 11px; color: #666; padding: 8px 0;">
                        Ej: Figuras ‚Üí Min: 2, Cr√≠tico: 1<br>
                        Decks ‚Üí Min: 10, Cr√≠tico: 3
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Descripci√≥n / Notas:</label>
                <textarea name="descripcion" id="descripcion" class="form-textarea" 
                          placeholder="Informaci√≥n adicional del producto..."></textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">üíæ Guardar</button>
                <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">üîÑ Limpiar</button>
            </div>
        </form>
    </div>
    
    <!-- Right Panel - Inventory List -->
    <div class="inventory-panel">
        <div class="section-title">CONSULTA DE INVENTARIO</div>
        
        <!-- Filters -->
        <div class="filters-bar">
            <form method="GET" class="filters-form">
                <div class="filter-group">
                    <label class="filter-label">Buscar:</label>
                    <input type="text" name="busqueda" class="filter-input" 
                           placeholder="C√≥digo o nombre..." value="{{ request.GET.busqueda }}">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Categor√≠a:</label>
                    <select name="categoria" class="filter-select">
                        <option value="">Todas</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria.id }}" 
                                {% if request.GET.categoria == categoria.id|stringformat:"s" %}selected{% endif %}>
                            {{ categoria.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Subcategor√≠a:</label>
                    <select name="subcategoria" class="filter-select">
                        <option value="">Todas</option>
                        {% for subcategoria in subcategorias %}
                        <option value="{{ subcategoria.id }}"
                                {% if request.GET.subcategoria == subcategoria.id|stringformat:"s" %}selected{% endif %}>
                            {{ subcategoria.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <button type="submit" class="btn-filter">üîç Filtrar</button>
            </form>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value">{{ total_productos }}</div>
                <div class="stat-label">Total Productos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ total_unidades }}</div>
                <div class="stat-label">Unidades en Stock</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #ffc107;">{{ stock_bajo }}</div>
                <div class="stat-label">Stock Bajo</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #dc3545;">{{ stock_critico }}</div>
                <div class="stat-label">Stock Cr√≠tico</div>
            </div>
        </div>
        
        <!-- Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 80px;">IMAGEN</th>
                        <th style="width: 100px;">C√ìDIGO</th>
                        <th>PRODUCTO</th>
                        <th style="width: 120px;">CATEGOR√çA</th>
                        <th style="width: 120px;">SUBCATEGOR√çA</th>
                        <th style="width: 80px;">STOCK</th>
                        <th style="width: 100px;">PRECIO</th>
                        <th style="width: 180px;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr>
                        <td>
                            <img src="{{ producto.get_imagen_url }}" 
                                 alt="{{ producto.nombre }}"
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">
                        </td>
                        <td class="col-codigo">{{ producto.codigo_sku }}</td>
                        <td>{{ producto.nombre }}</td>
                        <td>{{ producto.categoria.nombre }}</td>
                        <td>{{ producto.subcategoria.nombre|default:"‚Äî" }}</td>
                        <td class="col-stock {{ producto.get_clase_css_stock }}">
                            {{ producto.stock }}
                            {% if producto.get_estado_stock == 'CRITICO' %}
                                ‚ö†Ô∏è
                            {% elif producto.get_estado_stock == 'BAJO' %}
                                ‚ö°
                            {% endif %}
                        </td>
                        <td class="col-precio">${{ producto.precio|floatformat:0 }}</td>
                        <td>
                            <div class="action-btns">
                                <a href="{% url 'inventario:ajustar_stock' producto.id %}" class="btn-icon" style="color: #17a2b8; text-decoration: none;">
                                    üì¶ Stock
                                </a>
                                
                                {% if user.perfilusuario.rol.nombre == 'Administrador' %}
                                    <button class="btn-icon btn-edit" 
                                            onclick="editarProducto({{ producto.id }}, '{{ producto.nombre|escapejs }}', {{ producto.categoria.id }}, {{ producto.subcategoria.id|default:'null' }}, {{ producto.precio }}, {{ producto.stock }}, {{ producto.stock_minimo }}, {{ producto.stock_critico }}, '{{ producto.descripcion|default:''|escapejs }}', '{{ producto.get_imagen_url|escapejs }}')">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    
                                    <form method="POST" action="{% url 'inventario:eliminar_producto' producto.id %}" 
                                        style="display: inline;"
                                        onsubmit="return confirm('¬øEst√° seguro de dar de baja este producto?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-icon btn-delete">üóëÔ∏è Baja</button>
                                    </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            No hay productos registrados
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
function previewImagen(input) {
    const preview = document.getElementById('imagen-preview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.src = e.target.result;
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}

function editarProducto(id, nombre, categoria, subcategoria, precio, stock, stock_minimo, stock_critico, descripcion, imagen_url) {
    // Cambiar t√≠tulo del formulario
    document.getElementById('form-title').textContent = 'EDITAR PRODUCTO';
    
    // Cambiar acci√≥n del formulario
    document.getElementById('producto-form').action = `/inventario/editar/${id}/`;
    
    // Llenar campos
    document.getElementById('producto_id').value = id;
    document.getElementById('nombre').value = nombre;
    document.getElementById('categoria').value = categoria;
    document.getElementById('subcategoria').value = subcategoria || '';
    document.getElementById('precio').value = precio;
    document.getElementById('stock').value = stock;
    document.getElementById('stock_minimo').value = stock_minimo;
    document.getElementById('stock_critico').value = stock_critico;
    document.getElementById('descripcion').value = descripcion;
    
    // Mostrar imagen actual
    document.getElementById('imagen-preview').src = imagen_url;
    
    // Scroll hacia el formulario
    document.querySelector('.form-panel').scrollIntoView({ behavior: 'smooth' });
}

function limpiarFormulario() {
    document.getElementById('form-title').textContent = 'REGISTRO DE PRODUCTO NUEVO';
    document.getElementById('producto-form').action = "{% url 'inventario:crear_producto' %}";
    document.getElementById('producto-form').reset();
    document.getElementById('producto_id').value = '';
    // Restaurar valores por defecto
    document.getElementById('stock_minimo').value = '5';
    document.getElementById('stock_critico').value = '2';
    // Restaurar imagen por defecto
    document.getElementById('imagen-preview').src = '/static/images/no-image.png';
}
{% endblock %}